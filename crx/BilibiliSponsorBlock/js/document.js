(()=>{"use strict";var e={70:function(e,i){var t=this&&this.__awaiter||function(e,i,t,o){return new(t||(t=Promise))((function(n,r){function d(e){try{s(o.next(e))}catch(e){r(e)}}function a(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var i;e.done?n(e.value):(i=e.value,i instanceof t?i:new t((function(e){e(i)}))).then(d,a)}s((o=o.apply(e,i||[])).next())}))};Object.defineProperty(i,"__esModule",{value:!0}),i.PromiseTimeoutError=void 0,i.waitFor=function(e){return t(this,arguments,void 0,(function*(e,i=5e3,t=100,o){return yield new Promise(((n,r)=>{setTimeout((()=>{clearTimeout(a),r(`TIMEOUT waiting for ${null==e?void 0:e.toString()}: ${Error().stack}`)}),i);const d=()=>{const i=e();(o?o(i):i)&&(n(i),clearTimeout(a))};let a;const s=()=>setTimeout((()=>{d(),a=s()}),t);a=s(),d()}))}))},i.sleep=function(e){return t(this,void 0,void 0,(function*(){return yield new Promise((i=>{setTimeout(i,e)}))}))},i.objectToURI=function(e,i,t){let o=0;for(const n in i){const r=e.includes("?")||o>0?"&":t?"?":"",d="string"==typeof i[n]?i[n]:JSON.stringify(i[n]);e+=r+encodeURIComponent(n)+"="+encodeURIComponent(d),o++}return e},i.timeoutPomise=function(e){return new Promise(((i,t)=>{e&&setTimeout((()=>{t(new o)}),e)}))},i.isFirefoxOrSafari=n,i.isSafari=r,i.isFirefox=function(){return n()&&!r()};class o extends Error{constructor(e){super("Promise timed out"),this.promise=e}}function n(){return"undefined"!=typeof browser}function r(){return"undefined"!=typeof navigator&&"Apple Computer, Inc."===navigator.vendor}i.PromiseTimeoutError=o},135:function(e,i,t){var o=this&&this.__awaiter||function(e,i,t,o){return new(t||(t=Promise))((function(n,r){function d(e){try{s(o.next(e))}catch(e){r(e)}}function a(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var i;e.done?n(e.value):(i=e.value,i instanceof t?i:new t((function(e){e(i)}))).then(d,a)}s((o=o.apply(e,i||[])).next())}))};Object.defineProperty(i,"__esModule",{value:!0});const n=t(70),r=t(207),d=t(258),a=t(652),s=t(153),c=(e,i)=>{window.postMessage({source:r.sourceId,type:e.responseType,id:e.id,data:i},"/")};function l(e,i){var t,o;if(e.pathname.startsWith("/player/wbi/playurl")){const n=JSON.parse(i),r=e.searchParams.get("cid");r&&(null===(o=null===(t=null==n?void 0:n.data)||void 0===t?void 0:t.dash)||void 0===o?void 0:o.video)&&(0,s.savePlayInfo)(r,(0,s.playUrlResponseToPlayInfo)(n.data))}else if(e.pathname.startsWith("/x/player/wbi/v2")){const e=JSON.parse(i);(0,d.saveAidFromDetail)(e.data)}}window.addEventListener("message",(function(e){return o(this,void 0,void 0,(function*(){var i,t,o,n,l,u,v,f;const w=e.data;if(w&&(null==w?void 0:w.source)&&(null==w?void 0:w.source)===r.sourceId&&(null==w?void 0:w.responseType))if("getBvID"===w.type)(null===(i=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===i?void 0:i.bvid)&&(null===(t=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===t?void 0:t.cid)?c(w,`${null===(o=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===o?void 0:o.bvid}+${null===(n=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===n?void 0:n.cid}`):c(w,null);else if("getFrameRate"===w.type)c(w,(0,s.getFrameRate)());else if("getChannelID"===w.type)c(w,null===(u=null===(l=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===l?void 0:l.upData)||void 0===u?void 0:u.mid);else if("getDescription"===w.type)c(w,null===(f=null===(v=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===v?void 0:v.videoData)||void 0===f?void 0:f.desc);else if("convertAidToBvid"===w.type)c(w,yield(0,d.getBvid)(w.payload));else if("getCidFromBvid"===w.type){const e=w.payload;c(w,yield(0,a.getCidFromBvIdPage)(e.bvid,e.page))}else"getCidMap"===w.type&&c(w,yield(0,a.getCidMap)(w.payload))}))})),function(){const e=window.fetch;window.fetch=function(i,t){return o(this,void 0,void 0,(function*(){const o="string"==typeof i?i:i.url,n=yield e(i,t);return n.clone().text().then((e=>l(new URL(o,window.location.href),e))).catch((e=>{console.error("[BSB] Error processing URL Request: ",e)})),n}))}}(),function(){const e=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(i){this.addEventListener("loadend",(function(){if(this.readyState===this.DONE&&this.status>=200&&this.status<300)try{""!==this.responseType&&"text"!==this.responseType||l(new URL(this.responseURL),this.responseText)}catch(e){console.error("[BSB] Error processing URL Request: ",e)}})),e.call(this,i)}}(),(window.location.href.includes("t.bilibili.com")||window.location.href.includes("space.bilibili.com"))&&function(){o(this,void 0,void 0,(function*(){const e=new MutationObserver((e=>{var i,t;for(const o of e){const e=o.addedNodes[0].querySelector(".bili-dyn-item"),n=e.__vue__;if((null===(i=null==n?void 0:n.author)||void 0===i?void 0:i.mid)&&"AUTHOR_TYPE_NORMAL"===n.author.type){const i=n.author.mid;null===(t=e.querySelector(".bili-dyn-item__avatar"))||void 0===t||t.setAttribute("bilisponsor-userid",i.toString())}}}));function i(e){return o(this,void 0,void 0,(function*(){return yield(0,n.waitFor)((()=>document.querySelector(e)),5e3,50)}))}e.observe(yield i(".bili-dyn-list__items"),{attributeFilter:["class"],childList:!0}),(yield i(".bili-dyn-up-list__content, .nav-bar__main-left")).addEventListener("click",(()=>o(this,void 0,void 0,(function*(){e.disconnect(),e.observe(yield i(".bili-dyn-list__items"),{attributeFilter:["class"],childList:!0})}))))}))}()},153:(e,i,t)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.playUrlResponseToPlayInfo=n,i.savePlayInfo=function(e,i){o.set(e,i)},i.getPlayInfo=r,i.getFrameRate=function(){var e,i,t,o,n;let d=null;try{d||(d=null===(t=null===(i=JSON.parse(null===(e=null===window||void 0===window?void 0:window.localStorage)||void 0===e?void 0:e.bpx_player_profile))||void 0===i?void 0:i.media)||void 0===t?void 0:t.quality)}catch(e){console.debug("Failed to get current quality",e)}d=null!=d?d:null===(n=null===(o=null===window||void 0===window?void 0:window.__playinfo__)||void 0===o?void 0:o.data)||void 0===n?void 0:n.quality;const a=r().filter((e=>e.id===d&&!!e.frameRate));return a.length>0?a[0].frameRate:30};const o=new(t(464).DataCache)("play_info",(()=>[]));function n(e){return e?e.dash.video.map((e=>({id:e.id,frameRate:parseInt(e.frameRate)}))):null}function r(){var e,i,t,r,d;return(null===(t=null===(i=null===(e=window.__playinfo__)||void 0===e?void 0:e.data)||void 0===i?void 0:i.dash)||void 0===t?void 0:t.video)?n(null===(r=window.__playinfo__)||void 0===r?void 0:r.data):o.getFromCache(null===(d=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===d?void 0:d.cid.toString())?o.getFromCache(window.__INITIAL_STATE__.cid.toString()):[]}},207:function(e,i){var t=this&&this.__awaiter||function(e,i,t,o){return new(t||(t=Promise))((function(n,r){function d(e){try{s(o.next(e))}catch(e){r(e)}}function a(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var i;e.done?n(e.value):(i=e.value,i instanceof t?i:new t((function(e){e(i)}))).then(d,a)}s((o=o.apply(e,i||[])).next())}))};function o(e,o){return t(this,arguments,void 0,(function*(e,t,o=200){return new Promise((n=>{const r=`message_${Date.now()}_${Math.random().toString(36).substring(7)}`,d=t=>{var o;if((null===(o=t.data)||void 0===o?void 0:o.source)!==i.sourceId)return;const s=t.data;(null==s?void 0:s.type)===e.responseType&&(null==s?void 0:s.id)===r&&(clearTimeout(a),window.removeEventListener("message",d),n(s.data))};window.addEventListener("message",d),window.postMessage({source:i.sourceId,type:e.sendType,responseType:e.responseType,payload:t,id:r},"/");const a=setTimeout((()=>{window.removeEventListener("message",d),n(null)}),o)}))}))}Object.defineProperty(i,"__esModule",{value:!0}),i.sourceId=void 0,i.getPropertyFromWindow=o,i.getVideoDescriptionFromWindow=function(){return t(this,void 0,void 0,(function*(){return o({sendType:"getDescription",responseType:"returnDescription"})}))},i.getBvidFromAidFromWindow=function(e){return t(this,void 0,void 0,(function*(){return o({sendType:"convertAidToBvid",responseType:"returnAidToBvid"},e)}))},i.getCidFromBvidAndPageFromWindow=function(e,i){return t(this,void 0,void 0,(function*(){return o({sendType:"getCidFromBvid",responseType:"returnCidFromBvid"},{bvid:e,page:i})}))},i.getCidMapFromWindow=function(e){return t(this,void 0,void 0,(function*(){return o({sendType:"getCidMap",responseType:"returnCidMap"},e)}))},i.sourceId="biliSponsorBlock"},258:function(e,i,t){var o=this&&this.__awaiter||function(e,i,t,o){return new(t||(t=Promise))((function(n,r){function d(e){try{s(o.next(e))}catch(e){r(e)}}function a(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var i;e.done?n(e.value):(i=e.value,i instanceof t?i:new t((function(e){e(i)}))).then(d,a)}s((o=o.apply(e,i||[])).next())}))};Object.defineProperty(i,"__esModule",{value:!0}),i.saveAidFromDetail=function(e){d(e.aid,e.bvid)},i.saveAid=d,i.getBvid=function(e){return o(this,void 0,void 0,(function*(){var i;if("string"==typeof e&&e.startsWith("av")&&(e=e.replace("av","")),(null===(i=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===i?void 0:i.aid)&&window.__INITIAL_STATE__.bvid&&d(window.__INITIAL_STATE__.aid,window.__INITIAL_STATE__.bvid),!r.contains(e)){let i;try{i=(0,n.CalculateAvidToBvid)(e)}catch(i){console.error("Failed to calculate bvid from aid: "+e,i)}i&&r.set(e,i)}return r.getFromCache(e)}))};const n=t(534),r=new(t(464).DataCache);function d(e,i){"string"==typeof e&&e.startsWith("av")&&(e=e.replace("av","")),r.set(e,i)}},464:(e,i)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.DataCache=void 0,i.DataCache=class{constructor(e,i,t=2e3){this.cache={},this.init=i,this.cacheLimit=t,this.storageKey=e||"bsb_cache_default",this.persistEnabled=!!e}getFromCache(e){var i;return this.cacheUsed(e),null===(i=this.cache[e])||void 0===i?void 0:i.value}set(e,i){this.cache[e]={value:i,lastUsed:Date.now()},this.gc()}computeIfNotExists(e,i=this.init){return this.cache[e]||this.set(e,i()),this.getFromCache(e)}delete(e){delete this.cache[e]}cacheUsed(e){return this.cache[e]&&(this.cache[e].lastUsed=Date.now()),!!this.cache[e]}contains(e){return!!this.cache[e]}gc(){if(Object.keys(this.cache).length>this.cacheLimit){const e=Object.entries(this.cache).reduce(((e,i)=>e[1].lastUsed<i[1].lastUsed?e:i));delete this.cache[e[0]]}}clear(){this.cache={},this.persistEnabled&&localStorage.removeItem(this.storageKey)}}},534:(e,i)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.CalculateBvidToAvid=function(e){const i=Array.from(e);[i[3],i[9]]=[i[9],i[3]],[i[4],i[7]]=[i[7],i[4]],i.splice(0,3);const n=i.reduce(((e,i)=>e*r+BigInt(d.indexOf(i))),BigInt(0));return Number(n&o^t)},i.CalculateAvidToBvid=function(e){"string"==typeof e&&(e.startsWith("av")&&(e=e.replace("av","")),e=parseInt(e));const i=["B","V","1","0","0","0","0","0","0","0","0","0"];let o=i.length-1,a=(n|BigInt(e))^t;for(;a>0;)i[o]=d[Number(a%BigInt(r))],a/=r,o-=1;return[i[3],i[9]]=[i[9],i[3]],[i[4],i[7]]=[i[7],i[4]],i.join("")};const t=BigInt("23442827791579"),o=BigInt("2251799813685247"),n=BigInt(1)<<BigInt(51),r=BigInt(58),d="FcwAPNKTMug3GV5Lj7EJnHpWsx4tb8haYeviqBz6rkCy12mUSDQX9RdoZf"},652:(e,i,t)=>{Object.defineProperty(i,"__esModule",{value:!0}),i.saveCidMap=n,i.getCidMap=r,i.getCidFromBvIdPage=function(e,i){var t;return i||(i=1),(null===(t=r(e))||void 0===t?void 0:t.get(i))||null};const o=new(t(464).DataCache)("cid_map",(()=>new Map));function n(e,i){if(e&&i&&Array.isArray(i))try{const t=o.computeIfNotExists(e);for(const e of i)e&&void 0!==e.page&&e.cid&&t.set(e.page,e.cid)}catch(e){console.error("[BSB] Error saving CID map:",e)}else console.error("[BSB] Invalid data for saveCidMap",{bvid:e,pageList:i})}function r(e){var i,t,r;return e?((null===(t=null===(i=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===i?void 0:i.videoData)||void 0===t?void 0:t.pages)&&(null===(r=null===window||void 0===window?void 0:window.__INITIAL_STATE__)||void 0===r?void 0:r.bvid)===e&&n(e,window.__INITIAL_STATE__.videoData.pages),o.getFromCache(e)||new Map):(console.error("[BSB] Invalid BVID provided to getCidFromBvIdPage"),null)}}},i={};!function t(o){var n=i[o];if(void 0!==n)return n.exports;var r=i[o]={exports:{}};return e[o].call(r.exports,r,r.exports,t),r.exports}(135)})();